Implement the following fixes to resolve the identified issues, ensuring:

1.  The Analytics & Reports dashboard accurately and comprehensively reflects data from *all* uploaded contracts, including correct party information.
2.  The application seamlessly and automatically redirects the user to the correct chatbar interface for the newly uploaded contract upon successful upload completion.

**Mandatory Requirements for Agent Execution & Reporting:**

*   **Provide Detailed Logs:** For every step involving execution (e.g., code changes, running scripts, `curl` commands), capture and provide the full output/logs.
*   **Timestamp All Observations:** Include timestamps for all significant actions and log entries.
*   **Explain Reasoning:** For every change, explain *why* it was made and *what* it aims to achieve.
*   **Clear Root Cause Identification (Re-confirmation):** Briefly re-confirm the root cause before implementing the fix.
*   **Detailed Fix Implementation:** Provide exact code changes (file paths, line numbers, old code, new code) and explain the rationale behind the fix.
*   **Verification Steps & Confirmation:** Clearly outline how the fix was tested and confirm successful resolution with evidence.

**Implementation Plan:**

### **1. Fix Party Extraction in `server/contractExtractor.ts`**

**Root Cause:** The party extraction patterns in `contractExtractor.ts` are failing, resulting in empty arrays for `internal_parties` and `counterparties` in the database.

**Task:** Modify the `server/contractExtractor.ts` file to correct the regex patterns or the extraction logic for `internal_parties` and `counterparties`. The goal is to accurately identify and extract these entities from the contract text.

**Steps:**
1.  **Locate `server/contractExtractor.ts`:** Open this file.
2.  **Analyze Existing Patterns:** Review the current implementation for extracting parties. Identify the regex patterns or parsing logic used.
3.  **Develop/Refine Patterns:** Based on typical contract structures, refine or create new regex patterns that can reliably capture company names, individual names, or other party identifiers. Consider common variations (e.g., "[Company Name] LLC", "[Individual Name], [Title]").
4.  **Implement Fix:** Apply the refined patterns or logic within the `extractContractDetails` function (or equivalent) in `contractExtractor.ts`.
5.  **Test Extraction (Unit Test/Manual):** If unit tests exist for `contractExtractor.ts`, run them. Otherwise, perform a manual test by uploading a new contract with clear party information and verify that `internal_parties` and `counterparties` are correctly populated in the database.

**Expected Outcome:** When new contracts are processed, the `internal_parties` and `counterparties` fields in the database should no longer be empty arrays but contain the extracted party names.

### **2. Fix Upload Redirection Logic in `client/src/components/UploadModal.tsx` (and Address Authentication)**

**Root Cause:** The primary issue is "401 Unauthorized" errors during upload, preventing successful completion and subsequent redirection. A secondary concern is ensuring the `Dashboard` component correctly reads the `contractId` query parameter.

**Task:** First, address the authentication issue during upload. Second, ensure the redirection logic in `UploadModal.tsx` is robust and correctly passes the `contractId`.

**Steps:**
1.  **Address Authentication (401 Unauthorized):**
    *   **Diagnosis:** Investigate the upload API call in `client/src/components/UploadModal.tsx` (or related service file). Check how authentication tokens/headers are being sent. Compare with successful authenticated API calls in other parts of the application.
    *   **Fix:** Implement the necessary changes to ensure the upload API call is properly authenticated. This might involve:
        *   Ensuring the correct authentication token is retrieved (e.g., from `localStorage`, `sessionStorage`, or a global state).
        *   Attaching the token as an `Authorization` header (e.g., `Bearer <token>`).
        *   Verifying the token is not expired or invalid.
    *   **Verification:** Attempt a contract upload. Confirm that the 401 Unauthorized error no longer occurs and the upload completes successfully.
2.  **Refine Redirection Logic in `client/src/components/UploadModal.tsx`:**
    *   **Locate `client/src/components/UploadModal.tsx`:** Open this file.
    *   **Review Redirection Code:** Examine the `window.location.href` assignment or any routing library calls after a successful upload.
    *   **Ensure `contractId` Usage:** Confirm that the `result.contract.id` (or equivalent) is correctly appended to the redirection URL: `/dashboard?contractId=${result.contract.id}`.
    *   **Error Handling:** Add robust error handling for the upload process, providing user feedback if the upload fails for any reason (e.g., network error, server error).

**Expected Outcome:** Contract uploads should complete successfully without 401 errors. Upon successful upload, the user should be automatically redirected to the `/dashboard` page with the `contractId` query parameter, leading to the chatbar or specific contract view.

### **3. Add Contract Processing Endpoint for Existing Contracts in `server/routes.ts`**

**Root Cause:** Existing contracts processed before the `contractExtractor.ts` fix will still have empty party data. A mechanism is needed to re-process them.

**Task:** Create a new backend endpoint that can trigger the re-processing of existing contracts to populate their analytics data.

**Steps:**
1.  **Locate `server/routes.ts`:** Open this file.
2.  **Create New Endpoint:** Add a new POST or GET endpoint (e.g., `/api/process-existing-contracts`).
3.  **Implement Processing Logic:** In the handler for this new endpoint, implement logic to:
    *   Fetch all contracts from the database that need re-processing (e.g., contracts with empty `internal_parties` or `counterparties`, or all contracts if a full re-index is desired).
    *   For each fetched contract, call the `contractExtractor` (or the relevant function that performs the extraction) to re-extract details.
    *   Update the database records for these contracts with the newly extracted data.
    *   Return a success message or a summary of processed contracts.
4.  **Create `processExistingContracts.ts` (if not already existing):** If the diagnostic report implied a separate script, ensure this script exists and contains the logic to iterate through contracts and call the extraction function.

**Expected Outcome:** A new API endpoint will be available that, when called, re-processes existing contracts, updating their `internal_parties` and `counterparties` fields in the database.

### **4. Add Dashboard Contract ID Parameter Handling in `client/src/pages/Dashboard.tsx`**

**Root Cause:** The `Dashboard` component may not be correctly reading or utilizing the `contractId` query parameter from the URL, which is essential for post-upload redirection to a specific contract view.

**Task:** Modify `client/src/pages/Dashboard.tsx` to read the `contractId` query parameter from the URL and use it to load or highlight the specific contract.

**Steps:**
1.  **Locate `client/src/pages/Dashboard.tsx`:** Open this file.
2.  **Read Query Parameter:** Implement logic to read the `contractId` from the URL query parameters when the `Dashboard` component mounts or updates. (e.g., using `URLSearchParams` in JavaScript, or a routing library's method to access query params).
3.  **Utilize `contractId`:** Once the `contractId` is obtained, use it to:
    *   Automatically load the specific contract into the chatbar/analysis view.
    *   Highlight the contract in the "Recent Contracts" list.
    *   Trigger any necessary data fetching for that specific contract.

**Expected Outcome:** When navigating to `/dashboard?contractId=XYZ`, the dashboard should automatically load or focus on the contract with ID `XYZ`.

### **Verification and Post-Implementation Steps:**

1.  **Full Application Restart:** After implementing all code changes, perform a full restart of the Replit project to ensure all changes are applied.
2.  **Test New Contract Upload:**
    *   Upload a new contract with clear party information.
    *   Verify that the upload completes successfully (no 401 errors).
    *   Verify that you are automatically redirected to the dashboard/chatbar with the new contract loaded.
    *   Navigate to the Analytics & Reports page and confirm that the `internal_parties` and `counterparties` charts reflect data from this new contract.
3.  **Re-process Existing Contracts:**
    *   Call the new `/api/process-existing-contracts` endpoint (e.g., via `curl` or a browser request).
    *   **Verification:** After processing, check the database directly to confirm that `internal_parties` and `counterparties` fields are now populated for previously uploaded contracts.
    *   Navigate to the Analytics & Reports page and confirm that the `internal_parties` and `counterparties` charts now reflect data from *all* contracts.
4.  **Check Database Status:**
    *   Run the command: `psql $DATABASE_URL -c "SELECT COUNT(*) as total_contracts FROM contracts; SELECT COUNT(*) as contracts_with_details FROM contract_details;"`
    *   **Verification:** Confirm that `contracts_with_details` count is now closer to `total_contracts`, indicating more contracts have their details populated.

**Final Deliverable:**

A detailed report summarizing all implemented changes (with code diffs), the results of the verification steps, and confirmation that both the analytics dashboard data inconsistency and the chatbar redirection issues are resolved.